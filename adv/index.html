<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Webmulator Pro ++</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a2e 50%, #0a0a0a 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 40px 20px;
            animation: fadeInDown 0.8s ease;
        }

        .logo {
            font-size: 3em;
            font-weight: bold;
            background: linear-gradient(45deg, #00f5ff, #ff00ff, #00f5ff);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient 3s ease infinite;
        }

        .subtitle {
            color: #888;
            margin-top: 10px;
            font-size: 1.1em;
        }

        .badge {
            display: inline-block;
            padding: 5px 15px;
            background: linear-gradient(45deg, #ff00ff, #ff0080);
            border-radius: 20px;
            font-size: 1.2em;
            font-weight: bold;
            margin-left: 10px;
            animation: pulse 2s ease infinite;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .social-link {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 25px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #00f5ff;
            border-radius: 25px;
            color: #00f5ff;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
        }

        .social-link:hover {
            background: rgba(0, 245, 255, 0.1);
            box-shadow: 0 0 30px rgba(0, 245, 255, 0.6);
            transform: translateY(-2px);
        }

        .main-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 0.8s ease;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(0, 245, 255, 0.2);
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.03);
            border: none;
            color: #888;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px 10px 0 0;
            font-size: 1.1em;
            font-weight: 600;
            position: relative;
        }

        .tab:hover {
            color: #00f5ff;
            background: rgba(0, 245, 255, 0.05);
        }

        .tab.active {
            color: #00f5ff;
            background: rgba(0, 245, 255, 0.1);
            border-bottom: 3px solid #00f5ff;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        .upload-zone {
            border: 3px dashed rgba(0, 245, 255, 0.3);
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 245, 255, 0.1) 0%, transparent 70%);
            animation: pulseGlow 3s ease-in-out infinite;
        }

        .upload-zone:hover {
            border-color: #00f5ff;
            background: rgba(0, 245, 255, 0.05);
            transform: scale(1.02);
        }

        .upload-zone[drag="true"] {
            border-color: #ff00ff;
            background: rgba(255, 0, 255, 0.1);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        button {
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 245, 255, 0.4);
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 245, 255, 0.6);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button:active:not(:disabled) {
            transform: translateY(-1px);
        }

        .console-selector, select, input[type="file"]:not([hidden]) {
            padding: 12px 20px;
            font-size: 1.1em;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(0, 245, 255, 0.5);
            border-radius: 10px;
            color: white;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: calc(100% - 20px);
        }

        .console-selector:hover, select:hover {
            border-color: #00f5ff;
            background: rgba(0, 245, 255, 0.1);
        }

        #game {
            width: 100%;
            height: 600px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 245, 255, 0.3);
            margin: 20px 0;
        }

        .info-box {
            background: rgba(0, 245, 255, 0.05);
            border-left: 4px solid #00f5ff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            animation: fadeIn 1s ease;
        }

        .info-box h3 {
            color: #00f5ff;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #ccc;
            line-height: 1.6;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .log-display {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #00f5ff;
            margin: 20px 0;
        }

        .log-entry {
            padding: 5px;
            border-bottom: 1px solid rgba(0, 245, 255, 0.1);
        }

        .timestamp {
            color: #888;
            font-size: 0.85em;
        }

        details {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        summary {
            cursor: pointer;
            color: #00f5ff;
            font-weight: bold;
            padding: 10px;
            transition: all 0.3s ease;
        }

        summary:hover {
            color: #ff00ff;
        }

        /* Hex Editor Styles */
        .hex-editor {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .hex-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .hex-controls input {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 245, 255, 0.5);
            border-radius: 5px;
            color: white;
            font-family: 'Courier New', monospace;
        }

        .hex-viewer {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .hex-row {
            display: grid;
            grid-template-columns: 80px 1fr 200px;
            gap: 20px;
            padding: 4px 0;
            border-bottom: 1px solid rgba(0, 245, 255, 0.1);
        }

        .hex-row:hover {
            background: rgba(0, 245, 255, 0.05);
        }

        .hex-address {
            color: #ff00ff;
            font-weight: bold;
        }

        .hex-bytes {
            color: #00f5ff;
            letter-spacing: 2px;
        }

        .hex-ascii {
            color: #888;
        }

        .patch-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .patch-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-group label {
            color: #00f5ff;
            font-weight: 600;
        }

        textarea {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(0, 245, 255, 0.3);
            border-radius: 10px;
            color: #00f5ff;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
            min-height: 100px;
        }

        textarea:focus {
            outline: none;
            border-color: #00f5ff;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes pulseGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .patch-inputs {
                grid-template-columns: 1fr;
            }
            .hex-row {
                grid-template-columns: 60px 1fr;
                font-size: 0.8em;
            }
            .hex-ascii {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1 class="logo">WEBMULATOR PRO <span class="badge">++</span></h1>
            <p class="subtitle">Advanced Retro Gaming Platform with ROM Tools</p>
            <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <a href="https://instagram.com/12moneyy" target="_blank" class="social-link">
                    üì∏ Follow @12moneyy on Instagram
                </a>
                <a href="rompatchai.html" class="social-link" style="border-color: #ff00ff; color: #ff00ff; box-shadow: 0 0 20px rgba(255, 0, 255, 0.3);">
                    ü§ñ ROM Forge AI - Advanced Analysis
                </a>
            </div>
        </div>

        <div class="main-card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('emulator')">üéÆ Emulator</button>
                <button class="tab" onclick="switchTab('patcher')">üîß ROM Patcher</button>
                <button class="tab" onclick="switchTab('hexviewer')">üìä Hex Viewer</button>
            </div>

            <!-- EMULATOR TAB -->
            <div id="emulatorTab" class="tab-content active">
                <div id="welcomeSection">
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">üéÆ</div>
                        <h2>Drop ROM File Here</h2>
                        <p style="color: #888; margin: 15px 0;">or</p>
                        <input type="file" id="input" hidden>
                        <button id="uploadbutton">Browse Files</button>
                    </div>

                    <div class="info-box">
                        <h3>What is Webmulator Pro ++?</h3>
                        <p>A cutting-edge retro gaming platform with advanced ROM tools. Upload ROM files to play instantly, patch them with translations or fixes, or view their hex data. All sessions are tracked and exportable.</p>
                    </div>
                </div>

                <div id="gameSection" style="display: none;">
                    <div id="game"></div>

                    <div class="controls">
                        <button id="downloadLog">üì• Download Activity Log</button>
                        <button id="newGame">üîÑ Load New ROM</button>
                    </div>

                    <div class="info-box">
                        <h3 id="gameTitle">Game Information</h3>
                        <p id="gameInfo">Your gaming session is being tracked. All interactions are logged and can be downloaded.</p>
                    </div>

                    <details>
                        <summary>üìä View Activity Log</summary>
                        <div class="log-display" id="logDisplay"></div>
                    </details>
                </div>
            </div>

            <!-- ROM PATCHER TAB -->
            <div id="patcherTab" class="tab-content">
                <div class="info-box">
                    <h3>üîß Simple ROM Patcher</h3>
                    <p>Apply IPS, UPS, or BPS patches to your ROM files. Perfect for fan translations, bug fixes, and ROM hacks!</p>
                </div>

                <div class="patch-section">
                    <div class="input-group">
                        <label>1. Select Original ROM File</label>
                        <input type="file" id="romFile" accept=".nes,.smc,.sfc,.gba,.gb,.z64,.n64,.nds">
                    </div>

                    <div class="input-group">
                        <label>2. Select Patch File</label>
                        <input type="file" id="patchFile" accept=".ips,.ups,.bps,.patch">
                    </div>

                    <div class="controls">
                        <button id="applyPatch">Apply Patch</button>
                    </div>

                    <div id="patchResult" style="margin-top: 20px;"></div>
                </div>

                <div class="info-box">
                    <h3>Supported Formats</h3>
                    <p><strong>Patch formats:</strong> IPS, UPS, BPS
                        <br>
                        <strong>ROM formats:</strong> NES, SNES, GBA, GB, N64, NDS, and more</p>
                </div>
            </div>

            <!-- HEX VIEWER TAB -->
            <div id="hexviewerTab" class="tab-content">
                <div class="info-box">
                    <h3>üìä Hex Viewer</h3>
                    <p>View and analyze ROM files in hexadecimal format. Perfect for ROM hacking and understanding file structure.</p>
                </div>

                <div class="hex-editor">
                    <div class="hex-controls">
                        <input type="file" id="hexFile" accept="*" style="flex: 1;">
                        <input type="text" id="hexSearch" placeholder="Search hex (e.g., FF AA 00)" style="width: 200px;">
                        <button onclick="searchHex()">üîç Search</button>
                        <button onclick="exportHex()">üíæ Export</button>
                    </div>

                    <div id="hexViewer" class="hex-viewer">
                        <div style="text-align: center; color: #888; padding: 40px;">
                            Load a file to view its hexadecimal data
                        </div>
                    </div>
                </div>

                <div class="info-box">
                    <h3>Hex Viewer Features</h3>
                    <p>‚Ä¢ View any file in hex format
                        <br> ‚Ä¢ Address, Hex, and ASCII columns
                        <br> ‚Ä¢ Search for byte patterns
                        <br> ‚Ä¢ Export hex data
                        <br> ‚Ä¢ Color-coded display for easy reading</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            logActivity('Switched to ' + tabName + ' tab');
        }

        // Activity Logger
        const activityLog = [];
        
        function logActivity(action, details = {}) {
            const entry = {
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                userAgent: navigator.userAgent,
                screenResolution: `${window.innerWidth}x${window.innerHeight}`
            };
            activityLog.push(entry);
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logDisplay = document.getElementById('logDisplay');
            if (logDisplay && activityLog.length > 0) {
                const lastEntries = activityLog.slice(-20).reverse();
                logDisplay.innerHTML = lastEntries.map(entry => 
                    `<div class="log-entry">
                        <span class="timestamp">[${new Date(entry.timestamp).toLocaleTimeString()}]</span> 
                        ${entry.action}
                    </div>`
                ).join('');
            }
        }

        // Initialize
        logActivity('Page loaded');

        // ===== EMULATOR SECTION =====
        const input = document.getElementById('input');
        const uploadButton = document.getElementById('uploadbutton');
        const uploadZone = document.getElementById('uploadZone');

        uploadButton.addEventListener('click', () => {
            input.click();
            logActivity('Upload button clicked');
        });

        uploadZone.addEventListener('click', (e) => {
            if (e.target === uploadZone || e.target.classList.contains('upload-icon') || e.target.tagName === 'H2') {
                input.click();
                logActivity('Upload zone clicked');
            }
        });

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.setAttribute('drag', 'true');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.removeAttribute('drag');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.removeAttribute('drag');
            if (e.dataTransfer.files.length) {
                input.files = e.dataTransfer.files;
                input.dispatchEvent(new Event('change'));
                logActivity('File dropped', { fileName: e.dataTransfer.files[0].name });
            }
        });

        input.onchange = async () => {
            const file = input.files[0];
            const url = URL.createObjectURL(new Blob([file]));
            const parts = file.name.split(".");
            const fileName = parts[0];
            const ext = parts.pop().toLowerCase();

            logActivity('ROM file selected', { fileName: file.name, fileSize: file.size });

            const core = await (async (ext) => {
                if (["fds", "nes", "unif", "unf"].includes(ext)) return "nes";
                if (["smc", "fig", "sfc", "gd3", "gd7", "dx2", "bsx", "swc"].includes(ext)) return "snes";
                if (["z64", "n64"].includes(ext)) return "n64";
                if (["nds", "gba", "gb"].includes(ext)) return ext;

                return await new Promise(resolve => {
                    const cores = {
                        "Nintendo 64": "n64",
                        "Nintendo Game Boy": "gb",
                        "Nintendo Game Boy Advance": "gba",
                        "Nintendo DS": "nds",
                        "Nintendo Entertainment System": "nes",
                        "Super Nintendo Entertainment System": "snes",
                        "PlayStation": "psx",
                        "Virtual Boy": "vb",
                        "Sega Mega Drive": "segaMD",
                        "Sega Master System": "segaMS",
                        "Sega CD": "segaCD",
                        "Atari Lynx": "lynx",
                        "Sega 32X": "sega32x",
                        "Atari Jaguar": "jaguar",
                        "Sega Game Gear": "segaGG",
                        "Sega Saturn": "segaSaturn",
                        "Atari 7800": "atari7800",
                        "Atari 2600": "atari2600"
                    };

                    const modal = document.createElement('div');
                    modal.innerHTML = `
                        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                    background: rgba(10, 10, 10, 0.95); padding: 40px; border-radius: 20px; 
                                    border: 2px solid #00f5ff; z-index: 1000; text-align: center; box-shadow: 0 0 50px rgba(0, 245, 255, 0.5);">
                            <h2 style="color: #00f5ff; margin-bottom: 20px;">Select Console</h2>
                            <select class="console-selector" id="coreSelect">
                                ${Object.entries(cores).map(([name, value]) => 
                                    `<option value="${value}">${name}</option>`
                                ).join('')}
                            </select>
                            <br><br>
                            <button id="loadBtn">Load Game</button>
                        </div>
                    `;
                    document.body.appendChild(modal);

                    document.getElementById('loadBtn').onclick = () => {
                        const selected = document.getElementById('coreSelect').value;
                        logActivity('Console selected', { console: selected });
                        document.body.removeChild(modal);
                        resolve(selected);
                    };
                });
            })(ext);

            logActivity('Emulator core selected', { core: core });

            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'block';
            document.getElementById('gameTitle').textContent = `Now Playing: ${fileName}`;
            document.getElementById('gameInfo').textContent = `Console: ${core.toUpperCase()} | Started: ${new Date().toLocaleString()}`;

            window.EJS_player = "#game";
            window.EJS_gameName = fileName;
            window.EJS_biosUrl = "";
            window.EJS_gameUrl = url;
            window.EJS_core = core;
            window.EJS_pathtodata = "https://rawcdn.githack.com/EmulatorJS/EmulatorJS/main/data/";
            window.EJS_startOnLoaded = true;

            const script = document.createElement("script");
            script.src = "https://rawcdn.githack.com/EmulatorJS/EmulatorJS/main/data/loader.js";
            script.onload = () => {
                logActivity('Emulator loaded successfully', { game: fileName, core: core });
            };
            document.body.appendChild(script);
        };

        const downloadLogBtn = document.getElementById('downloadLog');
        if (downloadLogBtn) {
            downloadLogBtn.addEventListener('click', () => {
                const logData = {
                    exportDate: new Date().toISOString(),
                    totalActions: activityLog.length,
                    sessionDuration: activityLog.length > 0 ? 
                        (new Date() - new Date(activityLog[0].timestamp)) / 1000 / 60 : 0,
                    activities: activityLog
                };

                const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `webmulator_activity_${Date.now()}.savefile`;
                a.click();
                URL.revokeObjectURL(url);
                
                logActivity('Activity log downloaded');
            });
        }

        const newGameBtn = document.getElementById('newGame');
        if (newGameBtn) {
            newGameBtn.addEventListener('click', () => {
                logActivity('New game requested - page reload');
                location.reload();
            });
        }

        // ===== ROM PATCHER SECTION =====
        let romData = null;
        let patchData = null;

        document.getElementById('romFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                romData = await file.arrayBuffer();
                logActivity('ROM file loaded for patching', { fileName: file.name, size: file.size });
            }
        });

        document.getElementById('patchFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                patchData = await file.arrayBuffer();
                logActivity('Patch file loaded', { fileName: file.name, size: file.size });
            }
        });

        document.getElementById('applyPatch').addEventListener('click', () => {
            if (!romData || !patchData) {
                showPatchResult('Please select both a ROM and patch file!', 'error');
                return;
            }

            try {
                const patchedRom = applyIPSPatch(new Uint8Array(romData), new Uint8Array(patchData));
                
                const blob = new Blob([patchedRom], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'patched_rom.bin';
                a.click();
                URL.revokeObjectURL(url);

                showPatchResult('‚úÖ Patch applied successfully! Your patched ROM has been downloaded.', 'success');
                logActivity('Patch applied successfully');
            } catch (error) {
                showPatchResult('‚ùå Error applying patch: ' + error.message, 'error');
                logActivity('Patch application failed', { error: error.message });
            }
        });

        function showPatchResult(message, type) {
            const resultDiv = document.getElementById('patchResult');
            resultDiv.innerHTML = `<div class="info-box" style="border-left-color: ${type === 'success' ? '#00ff00' : '#ff0000'}">
                <p>${message}</p>
            </div>`;
        }

        function applyIPSPatch(rom, patch) {
            if (patch[0] !== 0x50 || patch[1] !== 0x41 || patch[2] !== 0x54 || patch[3] !== 0x43 || patch[4] !== 0x48) {
                throw new Error('Invalid IPS patch format');
            }

            const result = new Uint8Array(rom);
            let offset = 5;

            while (offset < patch.length - 3) {
                const patchOffset = (patch[offset] << 16) | (patch[offset + 1] << 8) | patch[offset + 2];
                offset += 3;

                if (patchOffset === 0x454F46) break;

                const size = (patch[offset] << 8) | patch[offset + 1];
                offset += 2;

                if (size === 0) {
                    const rleSize = (patch[offset] << 8) | patch[offset + 1];
                    offset += 2;
                    const rleByte = patch[offset++];
                    for (let i = 0; i < rleSize; i++) {
                        result[patchOffset + i] = rleByte;
                    }
                } else {
                    for (let i = 0; i < size; i++) {
                        result[patchOffset + i] = patch[offset++];
                    }
                }
            }

            return result;
        }

        // ===== HEX VIEWER SECTION =====
        let hexData = null;

        document.getElementById('hexFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                hexData = new Uint8Array(await file.arrayBuffer());
                displayHex(hexData);
                logActivity('File loaded in hex viewer', { fileName: file.name, size: file.size });
            }
        });

        function displayHex(data, startOffset = 0, maxRows = 500) {
            const viewer = document.getElementById('hexViewer');
            let html = '';
            
            const endOffset = Math.min(startOffset + (maxRows * 16), data.length);
            
            for (let i = startOffset; i < endOffset; i += 16) {
                const address = i.toString(16).toUpperCase().padStart(8, '0');
                let hexBytes = '';
                let ascii = '';
                
                for (let j = 0; j < 16; j++) {
                    if (i + j < data.length) {
                        const byte = data[i + j];
                        hexBytes += byte.toString(16).toUpperCase().padStart(2, '0') + ' ';
                        ascii += (byte >= 32 && byte <= 126) ? String.fromCharCode(byte) : '.';
                    } else {
                        hexBytes += '   ';
                        ascii += ' ';
                    }
                }
                
                html += `<div class="hex-row">
                    <div class="hex-address">${address}</div>
                    <div class="hex-bytes">${hexBytes}</div>
                    <div class="hex-ascii">${ascii}</div>
                </div>`;
            }
            
            if (endOffset < data.length) {
                html += `<div style="text-align: center; padding: 20px; color: #888;">
                    Showing first ${maxRows} rows (${endOffset} bytes of ${data.length} total)
                </div>`;
            }
            
            viewer.innerHTML = html;
        }

        function searchHex() {
            if (!hexData) {
                alert('Please load a file first!');
                return;
            }

            const searchInput = document.getElementById('hexSearch').value.trim();
            const searchBytes = searchInput.split(' ').map(b => parseInt(b, 16));
            
            if (searchBytes.some(isNaN)) {
                alert('Invalid hex format! Use format like: FF AA 00');
                return;
            }

            for (let i = 0; i <= hexData.length - searchBytes.length; i++) {
                let match = true;
                for (let j = 0; j < searchBytes.length; j++) {
                    if (hexData[i + j] !== searchBytes[j]) {
                        match = false;
                        break;
                    }
                }
                if (match) {
                    displayHex(hexData, Math.floor(i / 16) * 16);
                    logActivity('Hex pattern found', { offset: i, pattern: searchInput });
                    alert(`Pattern found at offset: 0x${i.toString(16).toUpperCase()}`);
                    return;
                }
            }
            
            alert('Pattern not found!');
            logActivity('Hex pattern not found', { pattern: searchInput });
        }

        function exportHex() {
            if (!hexData) {
                alert('Please load a file first!');
                return;
            }

            let hexText = '';
            for (let i = 0; i < hexData.length; i += 16) {
                const address = i.toString(16).toUpperCase().padStart(8, '0');
                let hexBytes = '';
                let ascii = '';
                
                for (let j = 0; j < 16 && i + j < hexData.length; j++) {
                    const byte = hexData[i + j];
                    hexBytes += byte.toString(16).toUpperCase().padStart(2, '0') + ' ';
                    ascii += (byte >= 32 && byte <= 126) ? String.fromCharCode(byte) : '.';
                }
                
                hexText += `${address}  ${hexBytes.padEnd(48, ' ')} ${ascii}\n`;
            }

            const blob = new Blob([hexText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hex_dump.txt';
            a.click();
            URL.revokeObjectURL(url);
            
            logActivity('Hex data exported');
        }

        // ===== TRACKING =====
        let lastMouseLog = 0;
        document.addEventListener('mousemove', (e) => {
            const now = Date.now();
            if (now - lastMouseLog > 5000) {
                logActivity('Mouse activity', { x: e.clientX, y: e.clientY });
                lastMouseLog = now;
            }
        });

        document.addEventListener('click', (e) => {
            logActivity('Click event', { 
                element: e.target.tagName, 
                id: e.target.id || 'none',
                className: e.target.className || 'none',
                position: `${e.clientX},${e.clientY}`
            });
        });

        document.addEventListener('visibilitychange', () => {
            logActivity(document.hidden ? 'Tab hidden' : 'Tab visible');
        });

        window.addEventListener('resize', () => {
            logActivity('Window resized', { 
                dimensions: `${window.innerWidth}x${window.innerHeight}` 
            });
        });

        window.addEventListener('beforeunload', () => {
            logActivity('User leaving page');
        });
    </script>
</body>

</html>
